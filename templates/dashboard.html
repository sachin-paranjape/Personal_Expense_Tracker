{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
	<h2 class="fw-bold mb-0">Dashboard</h2>
	<span class="text-muted">{{ now_date }}</span>
</div>

<!-- Prediction Section -->
<div class="row mb-4">
	<div class="col-12">
		<div class="glass-card p-4 border-start border-4 border-info">
			<div class="d-flex align-items-center justify-content-between">
				<div>
					<h5 class="card-title text-info mb-1 uppercase tracking-wider text-xs font-weight-bold">AI Insight
					</h5>
					<p class="mb-0 text-muted">Predicted Expense for Next Month</p>
				</div>
				<div class="text-end">
					{% if prediction > 0 %}
					<h2 class="display-5 fw-bold mb-0">₹{{ prediction }}</h2>
					<small class="text-muted">{{ pred_msg }}</small>
					{% else %}
					<p class="text-muted mb-0">{{ pred_msg }}</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row g-4 mb-4">
	<!-- Daily Spending -->
	<div class="col-md-6">
		<div class="glass-card p-4 h-100">
			<h5 class="fw-bold mb-4">Daily Spending (Last 7 Days)</h5>
			<div class="chart-container">
				<canvas id="dailyChart"></canvas>
			</div>
		</div>
	</div>
	<!-- Monthly Expenses -->
	<div class="col-md-6">
		<div class="glass-card p-4 h-100">
			<h5 class="fw-bold mb-4">Monthly Trends</h5>
			<div class="chart-container">
				<canvas id="monthlyChart"></canvas>
			</div>
		</div>
	</div>
</div>

<div class="row g-4">
	<!-- Category Breakdown -->
	<div class="col-md-6">
		<div class="glass-card p-4 h-100">
			<h5 class="fw-bold mb-4">Expense Distribution</h5>
			<div class="chart-container" style="height: 250px;">
				<canvas id="categoryChart"></canvas>
			</div>
		</div>
	</div>

	<!-- Budget Status -->
	<div class="col-md-6">
		<div class="glass-card p-4 h-100">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h5 class="fw-bold mb-0">Budget Status</h5>
				<a href="{{ url_for('manage_budget') }}" class="btn btn-sm btn-outline-primary rounded-pill">Manage</a>
			</div>

			{% if budget_report %}
			<div class="vstack gap-4">
				{% for b in budget_report %}
				<div>
					<div class="d-flex justify-content-between mb-1">
						<span class="fw-medium">{{ b.category }}</span>
						<span class="small text-{{ b.status_color }}">₹{{ b.spent }} / ₹{{ b.limit }}</span>
					</div>
					<div class="progress budget-progress bg-light" style="height: 8px;">
						<div class="progress-bar bg-{{ b.status_color }} rounded-pill" role="progressbar"
							style="width: {{ b.display_percent }}%" aria-valuenow="{{ b.display_percent }}"
							aria-valuemin="0" aria-valuemax="100"></div>
					</div>
					{% if b.is_over %}
					<small class="text-danger fw-bold mt-1 d-block"><i class="fas fa-exclamation-circle me-1"></i>Over
						Budget!</small>
					{% endif %}
				</div>
				{% endfor %}
			</div>
			{% else %}
			<div class="text-center py-5 text-muted">
				<i class="fas fa-piggy-bank fa-3x mb-3 text-light"></i>
				<p>No budgets set yet.</p>
				<a href="{{ url_for('manage_budget') }}" class="btn btn-primary btn-sm rounded-pill mt-2">Set a
					Budget</a>
			</div>
			{% endif %}
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	// Theme Colors
	const primaryColor = '#6366f1';
	const secondaryColor = '#ec4899';
	const successColor = '#10b981';
	const warningColor = '#f59e0b';
	const infoColor = '#3b82f6';

	// Data injected from server
	const dailyLabels = {{ daily_labels| tojson }};
	const dailyData = {{ daily_values| tojson }};
	const monthlyLabels = {{ monthly_labels| tojson }};
	const monthlyData = {{ monthly_values| tojson }};
	const categoryLabels = {{ category_labels| tojson }};
	const categoryData = {{ category_values| tojson }};

	// Chart Defaults
	Chart.defaults.font.family = "'Inter', sans-serif";
	Chart.defaults.color = '#6b7280';
	Chart.defaults.scale.grid.color = 'rgba(0,0,0,0.05)';

	// Daily Chart (Line)
	const dailyCtx = document.getElementById('dailyChart');
	new Chart(dailyCtx, {
		type: 'line',
		data: {
			labels: dailyLabels,
			datasets: [{
				label: 'Spending',
				data: dailyData,
				borderColor: primaryColor,
				backgroundColor: 'rgba(99, 102, 241, 0.1)',
				borderWidth: 2,
				tension: 0.4,
				fill: true,
				pointRadius: 3,
				pointHoverRadius: 6
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				legend: { display: false }
			},
			scales: {
				y: { beginAtZero: true, border: { display: false } },
				x: { grid: { display: false }, border: { display: false } }
			}
		}
	});

	// Monthly Chart (Bar)
	const monthlyCtx = document.getElementById('monthlyChart');
	new Chart(monthlyCtx, {
		type: 'bar',
		data: {
			labels: monthlyLabels,
			datasets: [{
				label: 'Expenses',
				data: monthlyData,
				backgroundColor: secondaryColor,
				borderRadius: 4,
				barThickness: 20
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				legend: { display: false }
			},
			scales: {
				y: { beginAtZero: true, border: { display: false } },
				x: { grid: { display: false }, border: { display: false } }
			}
		}
	});

	// Category Chart (Doughnut)
	const categoryCtx = document.getElementById('categoryChart');
	const palette = [primaryColor, secondaryColor, successColor, warningColor, infoColor, '#8b5cf6', '#ef4444'];
	new Chart(categoryCtx, {
		type: 'doughnut',
		data: {
			labels: categoryLabels,
			datasets: [{
				data: categoryData,
				backgroundColor: palette,
				borderWidth: 0,
				hoverOffset: 4
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			cutout: '70%',
			plugins: {
				legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } }
			}
		}
	});
</script>
{% endblock %}